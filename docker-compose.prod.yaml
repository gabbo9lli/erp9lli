version: '3.8'

services:
  # --- 1. The Proxy (Entry Point) ---
  proxy:
    # Build the Nginx service from the dedicated proxy folder
    build:
      context: ./proxy
      dockerfile: Dockerfile
    container_name: production_proxy
    volumes:
      - vue_static:/usr/share/nginx/html:ro # Read-only access to static files
    ports:
      - "80:80" 
    depends_on:
      - backend
      - frontend 

  backend:
    # Use the production Dockerfile with Gunicorn
    build:
      target: production
    container_name: backend_flask_gunicorn_prod
    expose:
      - "8000"
    env_file: .env.prod
    restart: always

  # --- 3. Frontend Service (Vue Build) ---
  frontend:
    build:
      target: production
    container_name: vue_build
    volumes:
      - vue_static:/app/dist # Assuming your build output is in /app/dist
    command: npm run build # Explicitly run the build command

volumes:
  vue_static: